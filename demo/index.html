<!DOCTYPE html>
<html>
    <head>

        <link rel="shortcut icon" href="#">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src='../dist/DynamicEntriesRenderer.js'></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    </head>

    <body>


        <div id="my_dynamic_entries_renderer">
            <form data-dynamic-entries-renderer-form>
                
                <nav class="navbar sticky-top navbar-light bg-light">
                    <a class="navbar-brand" href="#">Dynamic List Renderer</a>
                </nav>
                
                <div class="container mt-5">
                    
                    <div class="d-flex ">

                        <div class="form-group mr-4">
                            <label for="q">Search query</label>
                            <input type="text" class="form-control" id="q" data-dynamic-entries-renderer-filter-parameter="q" data-dynamic-entries-renderer-filter-default-value="" autocomplete="off">
                        </div>

                        <div class="form-group date-picker-range mr-4">
                            <label for="dateFrom">Date range</label>
                            <div class="d-flex">
                                <input type="text" class="form-control" size="11" id="dateFrom" data-dynamic-entries-renderer-filter-parameter="from" data-dynamic-entries-renderer-filter-default-value="" autocomplete="off">
                                <input type="text" class="form-control" size="11" id="dateTo" data-dynamic-entries-renderer-filter-parameter="to" data-dynamic-entries-renderer-filter-default-value="" autocomplete="off">
                            </div>
                    
                        </div>

                        <div class="form-group mr-4">
                            <label for="category">Category</label>
                            <select class="form-control" id="category" data-dynamic-entries-renderer-filter-parameter="category" data-dynamic-entries-renderer-filter-default-value="">
                                <option value="">All</option>
                                <option value="1">Category 1</option>
                                <option value="2">Category 2</option>
                                <option value="3">Category 3</option>
                            </select>
                        </div>

                        <div class="form-group ml-auto">
                            <label for="delta">Results per page</label>
                            <select class="form-control" id="delta" data-dynamic-entries-renderer-filter-parameter="delta" data-dynamic-entries-renderer-filter-default-value="6">
                                <option value="6">6</option>
                                <option value="9">9</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                        <input type="submit" style="display: none"/>

                    </div>
                    
                    <hr>

                    <div data-dynamic-entries-renderer-list>

                        <script id="template_dynamic-list-renderer-unique" type="text/template">
                            <div>

                                <div class="py-4" role="alert">
                                    Exibindo {{start}} a {{end}} de {{total}}
                                </div>

                                <div class="row">
                                    
                                    {{#entries}}
            
                                        <div class="col-md-4 mb-4">      
            
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h5 class="card-title">
                                                        <img class="" width="40" src="{{picture}}"> 
                                                        {{firstName}} {{lastName}}
                                                    </h5>
                                                    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                                                    <a href="#" class="btn btn-primary">Lorem</a>
                                                </div>
                                            </div>
                                            
                                        </div>
            
                                    {{/entries}}
            
                                </div>
                                
                            </div>
                        </script>

                        
                    </div>

                    <div class="mt-3" id="my_dynamic_entries_renderer_paginator">
                        <input type="hidden" data-dynamic-entries-renderer-filter-parameter="p" data-dynamic-entries-renderer-filter-default-value="1" />
                    </div>

                </div>

            </form>
        </div>


        <script>

            const parseHTML = (htmlString) => {
                const parser = new DOMParser();
                return parser.parseFromString(htmlString.trim(), 'text/html').body.firstChild;
            } 

            var serviceFetch = (p, delta) => {

                return fetch('https://dummyapi.io/data/v1/user?page='+(Number(p)-1)+'&limit='+delta, { 
                    method: 'GET',
                    headers: {
                        'app-id': '61cc1e2f679cb9641fa3f88f'
                    }
                })

            }

            var my_dynamic_entries_renderer = new DynamicEntriesRenderer('my_dynamic_entries_renderer', {
            
                submitOnFormChange: true,
                enableCaching: true,

                template: document.querySelector('#template_dynamic-list-renderer-unique').innerHTML,

                requestFn: (params, render) => {

                    let pageN = Number(params.p);
                    let delta = Number(params.delta);

                    serviceFetch(params.p, params.delta)
                    .then(response => {
                        return response.json()
                    })
                    .then(response => {
                        render({
                            entries: response.data,
                            total: response.total,
                            start: (pageN * delta) - (delta - 1),
                            end: (pageN * delta) - (delta - response.data.length),
                        })

                    }).catch(error => {
                        // error catch
                    })
                
                }, 

                onInit: function(instance) {
                    
                },


                onLoadingStart: function(instance) {
                    let currentPageN = instance.lastRequestParams.p

                    // Array.from(instance.$list.querySelectorAll('.card')).map(item => {
                    //     item.style.backgroundColor = "gray"
                    // })
                    // console.log('currentPageN', currentPageN)

                },

                onLoadingFinish: function(instance) {
                    let $pagination = document.getElementById('my_dynamic_entries_renderer_paginator');
                    
                    let total = Number(instance.response.total);
                    let currentFilterPage = Number(instance.getFilterElementValue('p'));
                    let currentFilterDelta = Number(instance.getFilterElementValue('delta'));
                    let pagesCount = Math.ceil(total / currentFilterDelta)

                    $pagination.innerHTML = ""
                    renderPagination($pagination, currentFilterPage, pagesCount, function(pageN) {
                        instance.setFilterElementValue('p', pageN);
                        instance.submit()
                    })  

                },


            });

            $('.date-picker-range').datepicker({
                inputs: $('.date-picker-range input'),
                language: 'pt-BR',
                format: 'dd/mm/yyyy'
            });

            $('.date-picker-range').on('changeDate', function() {
                my_dynamic_entries_renderer.submit()
            });
            
        </script>

    </body>

</html>
